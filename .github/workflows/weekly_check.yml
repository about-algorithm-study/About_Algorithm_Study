# .github/workflows/weekly_check.yml
name: ğŸ“Š Weekly Check (Organization)

on:
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰
  schedule:
    - cron: '0 15 * * 0'  # ë§¤ì£¼ ì¼ìš”ì¼ í•œêµ­ì‹œê°„ ìì • (UTC 15ì‹œ)
    
jobs:
  check-weekly-progress:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
        fetch-depth: 0
        ref: master
      
    - name: ğŸ”„ ê°•ì œ ë™ê¸°í™” (ì¶©ëŒ ë°©ì§€)
      env:
        GITHUB_TOKEN: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
      run: |
        echo "ğŸ”„ ì›ê²© ì €ì¥ì†Œì™€ ê°•ì œ ë™ê¸°í™” ì¤‘..."
        
        echo "ğŸ“‹ í˜„ì¬ Git ìƒíƒœ:"
        git status
        
        if [[ -n $(git status --porcelain) ]]; then
          echo "âš ï¸ ë¡œì»¬ ë³€ê²½ì‚¬í•­ ë°œê²¬ - ì„ì‹œ ì €ì¥"
          git stash push -m "GitHub Actions ì„ì‹œ ì €ì¥ $(date)"
        fi
        
        echo "ğŸ§¹ ì¶”ì ë˜ì§€ ì•ŠëŠ” íŒŒì¼ë“¤ ì •ë¦¬..."
        git clean -fd
        
        git fetch origin master
        git reset --hard origin/master
        
        echo "âœ… ê°•ì œ ë™ê¸°í™” ì™„ë£Œ"
        git status
        
    - name: ğŸ Python ì„¤ì •
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: ğŸ”§ Git ì„¤ì •
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
    - name: ğŸ” í™˜ê²½ ë° êµ¬ì¡° í™•ì¸
      run: |
        echo "ğŸ“‚ í˜„ì¬ ë””ë ‰í† ë¦¬: $(pwd)"
        echo "ğŸ“ ë£¨íŠ¸ íŒŒì¼ ëª©ë¡:"
        ls -la
        echo ""
        echo "ğŸ“„ README íŒŒì¼ë“¤:"
        find . -name "README.md" 2>/dev/null || echo "README íŒŒì¼ ì—†ìŒ"
        echo ""
        echo "ğŸ“ ì£¼ì°¨ í´ë” êµ¬ì¡°:"
        ls -la "8ì›”3ì£¼ì°¨/" 2>/dev/null || echo "8ì›”3ì£¼ì°¨ í´ë” ì—†ìŒ"
        ls -la "9ì›”1ì£¼ì°¨/" 2>/dev/null || echo "9ì›”1ì£¼ì°¨ í´ë” ì—†ìŒ"
        echo ""
        echo "ğŸ—‚ï¸ ë¬¸ì œ í´ë”ë“¤ (ì£¼ì°¨ë³„):"
        find . -type d -name "BOJ_*" -maxdepth 2 2>/dev/null || echo "BOJ ë¬¸ì œ í´ë” ì—†ìŒ"
        find . -type d -name "SWEA_*" -maxdepth 2 2>/dev/null || echo "SWEA ë¬¸ì œ í´ë” ì—†ìŒ"
        find . -type d -name "PRO_*" -maxdepth 2 2>/dev/null || echo "PRO ë¬¸ì œ í´ë” ì—†ìŒ"
        echo ""
        echo "ğŸ“ Python íŒŒì¼ë“¤:"
        find . -name "*.py" -maxdepth 3 2>/dev/null || echo "Python íŒŒì¼ ì—†ìŒ"
        
    - name: ğŸ“Š ì£¼ê°„ ì§„í–‰ìƒí™© ì²´í¬
      run: |
        echo "ğŸš€ ì£¼ê°„ ì•Œê³ ë¦¬ì¦˜ ìŠ¤í„°ë”” ì²´í¬ ì‹œì‘!"
        python scripts/weekly_check.py
        
    - name: ğŸ“ˆ ì£¼ê°„ ì§„í–‰ë¥  ì—…ë°ì´íŠ¸
      run: |
        echo "ğŸ“… ì£¼ê°„ ì§„í–‰ë¥  ì—…ë°ì´íŠ¸ ì‹œì‘!"
        python scripts/update_weekly_progress.py
        
    - name: ğŸ” ì‹¤í–‰ í›„ ìƒì„¸ í™•ì¸
      run: |
        echo "ğŸ” ì‹¤í–‰ í›„ ìƒíƒœ í™•ì¸"
        git status
        echo ""
        echo "ğŸ“Š ìƒì„±ëœ ë¡œê·¸:"
        ls -la logs/ 2>/dev/null || echo "ë¡œê·¸ í´ë” ì—†ìŒ"
        echo ""
        echo "ğŸ“‹ ë¡œê·¸ ë‚´ìš© ë¯¸ë¦¬ë³´ê¸°:"
        WEEK=$(date +%Y_W%V)
        if [ -f "logs/weekly_log_${WEEK}.json" ]; then
          echo "=== ì´ë²ˆ ì£¼ ë¡œê·¸ ==="
          head -20 "logs/weekly_log_${WEEK}.json"
        fi
        echo ""
        if [ -f "logs/weekly_progress_${WEEK}.json" ]; then
          echo "=== ì´ë²ˆ ì£¼ ì§„í–‰ë¥  ë¡œê·¸ ==="
          head -30 "logs/weekly_progress_${WEEK}.json"
        fi
        echo ""
        echo "ğŸ“„ README íŒŒì¼ í™•ì¸:"
        CURRENT_WEEK_FOLDER=$(ls -d *ì£¼ì°¨ 2>/dev/null | tail -1)
        if [ -f "${CURRENT_WEEK_FOLDER}/README.md" ]; then
          echo "=== README ì§„í–‰ í˜„í™© ì„¹ì…˜ ë¯¸ë¦¬ë³´ê¸° ==="
          grep -A 30 "## ğŸ“Š ì§„í–‰ í˜„í™©" "${CURRENT_WEEK_FOLDER}/README.md" || echo "ì§„í–‰ í˜„í™© ì„¹ì…˜ ì—†ìŒ"
        fi
        
    - name: ğŸ’¾ ìŠ¤ë§ˆíŠ¸ ì»¤ë°‹ ë° í‘¸ì‹œ (ê°œì„ ëœ ì¶©ëŒ ë°©ì§€)
      env:
        GITHUB_TOKEN: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
      run: |
        if [[ -n $(git status --porcelain) ]]; then
          echo "ğŸ“ ë³€ê²½ì‚¬í•­ ë°œê²¬ - ìŠ¤ë§ˆíŠ¸ ì»¤ë°‹ ì§„í–‰"
          
          echo "ğŸ“‹ ë³€ê²½ëœ íŒŒì¼ë“¤:"
          git status --porcelain
          
          git add .
          
          echo "ğŸ”„ í‘¸ì‹œ ì „ ì›ê²© ìƒíƒœ ì¬í™•ì¸..."
          git fetch origin master
          
          if ! git diff --quiet HEAD origin/master; then
            echo "âš ï¸ ì›ê²©ì— ìƒˆë¡œìš´ ë³€ê²½ì‚¬í•­ ë°œê²¬ - ìŠ¤ë§ˆíŠ¸ ë³‘í•© ì‹œë„"
            
            git commit -m "ì„ì‹œ ì»¤ë°‹: $(date +'%Y-%m-%d %H:%M')"
            
            git pull origin master --strategy=ours --no-edit || {
              echo "âŒ ìŠ¤ë§ˆíŠ¸ ë³‘í•© ì‹¤íŒ¨ - ìˆ˜ë™ ë³‘í•© ì‹œë„"
              
              git merge origin/master --strategy-option=ours --no-edit || {
                echo "âš ï¸ ë³‘í•© ì¶©ëŒ ë°œìƒ - ìë™ í•´ê²° ì‹œë„"
                
                CURRENT_WEEK_FOLDER=$(ls -d *ì£¼ì°¨ 2>/dev/null | tail -1)
                if [ -f "${CURRENT_WEEK_FOLDER}/README.md" ]; then
                  git checkout --ours "${CURRENT_WEEK_FOLDER}/README.md"
                  git add "${CURRENT_WEEK_FOLDER}/README.md"
                  echo "âœ… README.md ì¶©ëŒ í•´ê²° (ìš°ë¦¬ ë²„ì „ ì‚¬ìš©)"
                fi
                
                if [ -d "logs" ]; then
                  git add logs/
                  echo "âœ… logs í´ë” ì¶©ëŒ í•´ê²° (ìš°ë¦¬ ë²„ì „ ì‚¬ìš©)"
                fi
                
                git commit --no-edit
              }
            }
            
            git commit --amend -m "ğŸ“… ìë™ ì—…ë°ì´íŠ¸: $(date +'%Y-%m-%d %H:%M') - ì£¼ê°„ ì§„í–‰ë¥ "
          else
            git commit -m "ğŸ“… ìë™ ì—…ë°ì´íŠ¸: $(date +'%Y-%m-%d %H:%M') - ì£¼ê°„ ì§„í–‰ë¥ "
          fi
          
          MAX_RETRIES=5
          RETRY_COUNT=0
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            echo "ğŸš€ í‘¸ì‹œ ì‹œë„ ($((RETRY_COUNT + 1))/$MAX_RETRIES)..."
            
            if git push origin master; then
              echo "âœ… í‘¸ì‹œ ì„±ê³µ!"
              break
            else
              echo "âŒ í‘¸ì‹œ ì‹¤íŒ¨ - ì¬ì‹œë„ ì¤€ë¹„ ì¤‘..."
              RETRY_COUNT=$((RETRY_COUNT + 1))
              
              if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                echo "ğŸ”„ ìµœì‹  ë³€ê²½ì‚¬í•­ ë‹¤ì‹œ ê°€ì ¸ì˜¤ê¸°..."
                
                git fetch origin master
                
                git rebase origin/master || {
                  echo "âš ï¸ ë¦¬ë² ì´ìŠ¤ ì‹¤íŒ¨ - ë³‘í•©ìœ¼ë¡œ ì¬ì‹œë„"
                  git rebase --abort
                  git merge origin/master --strategy-option=ours --no-edit
                }
                
                echo "â³ $((3 * RETRY_COUNT))ì´ˆ ëŒ€ê¸° í›„ ì¬ì‹œë„..."
                sleep $((3 * RETRY_COUNT))
              else
                echo "âŒ ìµœëŒ€ ì¬ì‹œë„ íšŸìˆ˜ ì´ˆê³¼"
                echo "ğŸ“‹ ìµœì¢… ìƒíƒœ:"
                git status
                git log --oneline -5
                exit 1
              fi
            fi
          done
        else
          echo "â„¹ï¸ ë³€ê²½ì‚¬í•­ ì—†ìŒ - ì»¤ë°‹í•  ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤"
        fi

    - name: ğŸ“Š ê²°ê³¼ ìš”ì•½
      run: |
        echo "ğŸ‰ GitHub Actions ì‹¤í–‰ ì™„ë£Œ!"
        echo "ğŸ¢ Organization: about-algorithm-study"
        echo "ğŸ“ˆ ìŠ¤í„°ë”” ë©¤ë²„: ê¹€ê°•ì—°, ì‹ ì¬í˜, ì˜¤ì°½ë¯¼, ì†¡ë¯¼ê²½, ìµœì¬ê°"
        echo "ğŸ“ íŒŒì¼ êµ¬ì¡°: ì£¼ì°¨í´ë”/ë¬¸ì œí´ë”/íŒŒì¼ëª….py"
        echo "ğŸ¤– ìë™í™”: ì£¼ê°„ ì²´í¬ + ì£¼ê°„ ì§„í–‰ë¥  ì—…ë°ì´íŠ¸ + ìŠ¤ë§ˆíŠ¸ ì¶©ëŒ í•´ê²°"
        echo "ğŸ“… ì£¼ê°„ ì§„í–‰ë¥ : 1ì£¼ì¼ì— 9ë¬¸ì œ ì§„í–‰ ìƒí™© ì¶”ì "
        echo "ğŸ”— ê²°ê³¼ í™•ì¸: https://github.com/about-algorithm-study/About_Algorithm_Study"
        echo ""
        echo "ğŸ“‹ ìµœì¢… Git ìƒíƒœ:"
        git status
        echo ""
        echo "ğŸ“œ ìµœê·¼ ì»¤ë°‹:"
        git log --oneline -3